const API_KEY = "<-- API_KEY_PLACEHOLDER -->"; let latestSensorData = null; let chartDataInitialized = false; const chartH = Highcharts.chart('sensors-chart', { chart: { type: 'areaspline', animation: Highcharts.svg }, title: { text: '' }, xAxis: { type: 'datetime', tickPixelInterval: 150 }, yAxis: [{ title: { text: '' }, tickPositions: [0, 25, 50, 75, 100], labels: { style: { color: 'rgb(100,149,237)', fontWeight: 'bold' } } }, { title: { text: '' }, tickPositions: [0, 10, 20, 30, 40], opposite: true, labels: { style: { color: 'rgb(247,38,59)', fontWeight: 'bold' } } }], plotOptions: { spline: { lineWidth: 2, marker: { enabled: true } } }, series: [{ name: 'Soil Moisture', data: [], yAxis: 0, color: 'rgb(100,149,237)', fillColor: 'rgba(100,149,237,0.2)' }, { name: 'Temperature', data: [], yAxis: 1, color: 'rgba(247,38,59,0.2)' }], credits: { enabled: false } }); const ws = new WebSocket('ws://' + location.hostname + '/ws'); ws.onopen = () => console.log('WebSocket open'); ws.onerror = e => console.error('WebSocket error', e); ws.onmessage = e => { try { const d = JSON.parse(e.data); latestSensorData = d; if (d.temperature >= 0) document.getElementById('temperatureValue').textContent = `${d.temperature} Â°C`; if (d.humidity >= 0) document.getElementById('humidityValue').textContent = `${d.humidity} %`; if (d.moisture >= 0) document.getElementById('moistureValue').textContent = `${d.moisture} %`; if (d.lighting) document.getElementById('lightingValue').textContent = d.lighting; if (d.weather) document.getElementById('weatherValue').textContent = d.weather; const btn = document.getElementById('waterButton'); const span = document.getElementById('wateringValue'); const isOver = (d.plantStatus || '').toLowerCase() === 'overwatered'; if (d.pumpStatus === 'ON') { span.textContent = 'ON'; btn.innerHTML = `<i class="fas fa-tint"></i> Watering${d.countdown > 0 ? ` (${d.countdown})` : ''}`; btn.disabled = true; } else if (isOver) { btn.innerHTML = `<i class="fas fa-tint"></i> Water Plant`; btn.disabled = true; span.textContent = 'OFF'; } else { span.textContent = 'OFF'; btn.innerHTML = `<i class="fas fa-tint"></i> Water Plant`; btn.disabled = false; } const badge = document.getElementById('plantStatusBadge'); badge.textContent = d.plantStatus; let statusColor = '#999'; switch ((d.plantStatus || '').toLowerCase()) { case 'overwatered': statusColor = '#61B8E4'; break; case 'healthy': statusColor = '#7DA417'; break; case 'thirsty': statusColor = '#F5BA0D'; break; case 'dry': statusColor = '#F7263B'; break; } badge.style.backgroundColor = statusColor; badge.style.filter = `drop-shadow(0 0 20px ${statusColor})`; document.getElementById('plantImage').style.filter = `drop-shadow(0 0 20px ${statusColor})`; if (!chartDataInitialized) { loadChartData(); chartDataInitialized = true; } } catch (err) { console.error('WS parse error', err); } }; function loadChartData() { if (!latestSensorData) return; const now = Date.now(); const m = parseFloat(latestSensorData.moisture) || 0; const t = parseFloat(latestSensorData.temperature) || 0; chartH.series[0].addPoint([now, m], true, chartH.series[0].data.length >= 7); chartH.series[1].addPoint([now, t], true, chartH.series[1].data.length >= 7); } async function waterPlant() { try { const res = await fetch(`/water?time=5&token=${API_KEY}`); if (!res.ok) throw new Error(res.statusText); document.getElementById('wateringValue').textContent = 'ON'; const btn = document.getElementById('waterButton'); btn.innerHTML = `<i class="fas fa-tint"></i> Watering`; btn.disabled = true; } catch (err) { console.error('Water API error', err); } } document.getElementById('waterButton').addEventListener('click', waterPlant); setInterval(loadChartData, 10000); loadChartData(); document.addEventListener('DOMContentLoaded', () => { const overlay = document.getElementById('loadingOverlay'); const mainWrapper = document.querySelector('.main-wrapper'); mainWrapper.style.opacity = 0; setTimeout(() => { overlay.style.opacity = 0; setTimeout(() => { mainWrapper.style.opacity = 1; setTimeout(() => overlay.style.display = 'none', 300); }, 150); }, 1500); });
