const API_KEY = "<-- API_KEY_PLACEHOLDER -->"; let latestSensorData = null; let chartDataInitialized = false; const chartH = Highcharts.chart('sensors-chart', { chart: { type: 'areaspline', animation: Highcharts.svg }, title: { text: '' }, xAxis: { type: 'datetime', tickPixelInterval: 150 }, yAxis: [{ title: { text: '' }, tickPositions: [0, 25, 50, 75, 100], labels: { style: { color: 'rgb(100,149,237)', fontWeight: 'bold' } } }, { title: { text: '' }, tickPositions: [0, 10, 20, 30, 40], opposite: true, labels: { style: { color: 'rgb(247,38,59)', fontWeight: 'bold' } } }], plotOptions: { spline: { lineWidth: 2, marker: { enabled: true } } }, series: [{ name: 'Soil Moisture', data: [], yAxis: 0, color: 'rgb(100,149,237)', fillColor: 'rgba(100,149,237,0.2)' }, { name: 'Temperature', data: [], yAxis: 1, color: 'rgba(247,38,59,0.2)' }], credits: { enabled: false } }); const ws = new WebSocket('ws://' + location.hostname + '/ws'); ws.onopen = () => console.log('WebSocket open'); ws.onerror = e => console.error('WebSocket error', e); ws.onmessage = e => { try { const d = JSON.parse(e.data); latestSensorData = d; if (d.temperature >= 0) document.getElementById('temperatureValue').textContent = `${d.temperature} Â°C`; if (d.humidity >= 0) document.getElementById('humidityValue').textContent = `${d.humidity} %`; if (d.moisture >= 0) document.getElementById('moistureValue').textContent = `${d.moisture} %`; if (d.lighting) document.getElementById('lightingValue').textContent = d.lighting; if (d.weather) document.getElementById('weatherValue').textContent = d.weather; const btn = document.getElementById('waterButton'); const span = document.getElementById('wateringValue'); const isOver = (d.plantStatus || '').toLowerCase() === 'overwatered'; if (d.pumpStatus === 'ON') { span.textContent = 'ON'; btn.innerHTML = `<i class="fas fa-tint"></i> Watering${d.countdown > 0 ? ` (${d.countdown})` : ''}`; btn.disabled = true; } else if (isOver) { btn.innerHTML = `<i class="fas fa-tint"></i> Water Plant`; btn.disabled = true; span.textContent = 'OFF'; } else { span.textContent = 'OFF'; btn.innerHTML = `<i class="fas fa-tint"></i> Water Plant`; btn.disabled = false; } const badge = document.getElementById('plantStatusBadge'); badge.textContent = d.plantStatus; let statusColor = '#999'; switch ((d.plantStatus || '').toLowerCase()) { case 'overwatered': statusColor = '#61B8E4'; break; case 'healthy': statusColor = '#7DA417'; break; case 'thirsty': statusColor = '#F5BA0D'; break; case 'dry': statusColor = '#F7263B'; break; } badge.style.backgroundColor = statusColor; badge.style.filter = `drop-shadow(0 0 20px ${statusColor})`; document.getElementById('plantImage').style.filter = `drop-shadow(0 0 20px ${statusColor})`; if (!chartDataInitialized) { loadChartData(); chartDataInitialized = true; } } catch (err) { console.error('WS parse error', err); } }; function loadChartData() { if (!latestSensorData) return; const now = Date.now(); const m = parseFloat(latestSensorData.moisture) || 0; const t = parseFloat(latestSensorData.temperature) || 0; chartH.series[0].addPoint([now, m], true, chartH.series[0].data.length >= 7); chartH.series[1].addPoint([now, t], true, chartH.series[1].data.length >= 7); } async function waterPlant() { try { const res = await fetch(`/water?time=5&token=${API_KEY}`); if (!res.ok) throw new Error(res.statusText); document.getElementById('wateringValue').textContent = 'ON'; const btn = document.getElementById('waterButton'); btn.innerHTML = `<i class="fas fa-tint"></i> Watering`; btn.disabled = true; } catch (err) { console.error('Water API error', err); } } document.getElementById('waterButton').addEventListener('click', waterPlant);  const sliderHandle = document.getElementById('sliderHandle'); const progressCircle = document.getElementById('progressCircle'); const durationValue = document.getElementById('durationValue'); const circularSlider = document.querySelector('.circular-slider'); let radius = 85; let centerPoint = 110; let circumference = 2 * Math.PI * radius; let currentDuration = 15; let isDragging = false;  progressCircle.style.strokeDasharray = circumference; updateSlider(currentDuration); function updateSliderSize() { const sliderWidth = circularSlider.offsetWidth; if (sliderWidth <= 200) {  radius = 75; centerPoint = 90; } else {  radius = 85; centerPoint = 110; } circumference = 2 * Math.PI * radius;  const svg = document.querySelector('.slider-svg'); const track = document.querySelector('.slider-track'); const progress = document.querySelector('.slider-progress');  const viewBoxSize = centerPoint * 2; svg.setAttribute('viewBox', `0 0 ${viewBoxSize} ${viewBoxSize}`);  track.setAttribute('cx', centerPoint); track.setAttribute('cy', centerPoint); track.setAttribute('r', radius); progress.setAttribute('cx', centerPoint); progress.setAttribute('cy', centerPoint); progress.setAttribute('r', radius);  if (sliderWidth <= 200) { document.querySelectorAll('.step-marker').forEach(marker => { const text = marker.textContent; switch (text) { case '0': marker.style.top = '0px'; marker.style.left = '90px'; break; case '5': marker.style.top = '12px'; marker.style.right = '35px'; break; case '10': marker.style.top = '42px'; marker.style.right = '0px'; break; case '15': marker.style.top = '90px'; marker.style.right = '-8px'; break; case '20': marker.style.bottom = '38px'; marker.style.right = '0px'; break; case '25': marker.style.bottom = '8px'; marker.style.right = '35px'; break; case '30': marker.style.bottom = '-7px'; marker.style.left = '90px'; break; case '35': marker.style.bottom = '8px'; marker.style.left = '30px'; break; case '40': marker.style.bottom = '38px'; marker.style.left = '0px'; break; case '45': marker.style.top = '90px'; marker.style.left = '-8px'; break; case '50': marker.style.top = '42px'; marker.style.left = '0px'; break; case '55': marker.style.top = '12px'; marker.style.left = '30px'; break; } }); } else {  document.querySelectorAll('.step-marker').forEach(marker => { const text = marker.textContent; switch (text) { case '0': marker.style.top = '0px'; marker.style.left = '110px'; break; case '5': marker.style.top = '13px'; marker.style.right = '37px'; break; case '10': marker.style.top = '55px'; marker.style.right = '-5px'; break; case '15': marker.style.top = '112px'; marker.style.right = '-22px'; break; case '20': marker.style.bottom = '35px'; marker.style.right = '-7px'; break; case '25': marker.style.bottom = '-2px'; marker.style.right = '32px'; break; case '30': marker.style.bottom = '-18px'; marker.style.left = '110px'; break; case '35': marker.style.bottom = '-3px'; marker.style.left = '52px'; break; case '40': marker.style.bottom = '40px'; marker.style.left = '10px'; break; case '45': marker.style.top = '110px'; marker.style.left = '-5px'; break; case '50': marker.style.top = '55px'; marker.style.left = '10px'; break; case '55': marker.style.top = '15px'; marker.style.left = '50px'; break; } }); } return { radius, centerPoint, circumference }; } function updateSlider(minutes) { currentDuration = Math.max(0, Math.min(60, minutes)); const { radius, centerPoint, circumference } = updateSliderSize(); const angle = (currentDuration / 60) * 360; const radians = (angle - 90) * (Math.PI / 180); const x = centerPoint + radius * Math.cos(radians); const y = centerPoint + radius * Math.sin(radians); sliderHandle.style.left = `${x}px`; sliderHandle.style.top = `${y}px`; const offset = currentDuration === 0 ? circumference : circumference - (currentDuration / 60) * circumference; progressCircle.style.strokeDashoffset = offset; durationValue.textContent = currentDuration; }  sliderHandle.addEventListener('mousedown', () => { isDragging = true; sliderHandle.style.cursor = 'grabbing'; }); document.addEventListener('mouseup', () => { isDragging = false; sliderHandle.style.cursor = 'grab'; }); document.addEventListener('mousemove', (e) => { if (!isDragging) return; const rect = circularSlider.getBoundingClientRect(); const centerX = rect.left + rect.width / 2; const centerY = rect.top + rect.height / 2; const angle = Math.atan2(e.clientY - centerY, e.clientX - centerX); let degrees = (angle * 180 / Math.PI + 90 + 360) % 360; let minutes = Math.round((degrees / 360) * 60 / 5) * 5; if (minutes === 60) minutes = 0; updateSlider(minutes); });  sliderHandle.addEventListener('touchstart', (e) => { e.preventDefault(); isDragging = true; }, { passive: false }); document.addEventListener('touchend', () => { isDragging = false; }); document.addEventListener('touchmove', (e) => { if (!isDragging) return; e.preventDefault(); const touch = e.touches[0]; const rect = circularSlider.getBoundingClientRect(); const centerX = rect.left + rect.width / 2; const centerY = rect.top + rect.height / 2; const angle = Math.atan2(touch.clientY - centerY, touch.clientX - centerX); let degrees = (angle * 180 / Math.PI + 90 + 360) % 360; let minutes = Math.round((degrees / 360) * 60 / 5) * 5; if (minutes === 60) minutes = 0; updateSlider(minutes); }, { passive: false });  window.addEventListener('load', () => { updateSliderSize(); updateSlider(currentDuration); });  window.addEventListener('resize', () => { updateSliderSize(); updateSlider(currentDuration); });  setInterval(loadChartData, 10000); loadChartData();  document.addEventListener('DOMContentLoaded', () => { const overlay = document.getElementById('loadingOverlay'); const mainWrapper = document.querySelector('.main-wrapper'); mainWrapper.style.opacity = 0; setTimeout(() => { overlay.style.opacity = 0; setTimeout(() => { mainWrapper.style.opacity = 1; setTimeout(() => overlay.style.display = 'none', 300); }, 150); }, 1500); });
